pico-8 cartridge // http://www.pico-8.com
version 16
__lua__
left,right,up,down,fire1,fire2=0,1,2,3,4,5
black,dark_blue,dark_purple,dark_green,brown,dark_gray,light_gray,white,red,orange,yellow,green,blue,indigo,pink,peach=0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15

function make_cn(b)
 return {
  a=0,b=b,
  notation=function(s)
   if s.b==0 then
    return "error"
   elseif abs(s.b)==1 then
    return s.b>0 and "i" or "-i"
   else
    return s.b.."i"
   end
  end,
  equals=function(s,a)
   return s.a==a.a and s.b==a.b
  end
 }
end

-->8
function add_test(t)
 add(suite,{
  run=false,
  fun=t,
  effect=nil,
  test=function(s)
   s.effect=make_fire(s.x+s.w/2,s.y+s.h/2,20)
   s:fun()
   s.curanim=#s.messages==0 and "good" or "fail"
  end,
  messages={},
  assert_eq=function(s,a,b)
   run=true
   if a~=b then 
    add(s.messages,"failure:"..a.." is not "..b)
   end
  end,
  assert_true=function(s,f)
   run=true
   if not f then
    add(s.messages,"failure:")
   end
  end,
  x=#suite*18,y=48,
  w=16,h=16,
  anims={
   ["wait"]={
     ticks=4,
     frames={18,20},
     color=dark_gray
   },
   ["good"]={
     ticks=1,
     frames={22},
     color=green
   },
   ["fail"]={
     ticks=1,
     frames={24},
     color=red
   }
  },
  curanim="wait",
  curframe=1,
  animtick=0,
  color=dark_gray,
  update=function(s)
   if s.effect~=nil then s.effect:update() end
   s.animtick-=1
   if s.animtick<=0 then
     s.curframe+=1
     local a=s.anims[s.curanim]
     s.animtick=a.ticks
     s.color=a.color
     if s.curframe>#a.frames then
       s.curframe=1
     end
   end
  end,
  draw=function(s)
   if s.effect~=nil then s.effect:draw() end
	 local f=s.anims[s.curanim].frames[s.curframe]
	 color(s.color)
   print(s.curanim,s.x,s.y-8)
--   print(f,s.x,s.y+s.h+2)
--   rect(s.x,s.y,s.x+s.w,s.y+s.h)
   spr(f,s.x,s.y,2,2)
  end,
 })
end

-->8
function reset()
 cnt=1
 suite={}
 add_test(function(s)
  s:assert_eq(make_cn(1):notation(),"i")
 end)
 add_test(function(s)
  s:assert_eq(make_cn(-1):notation(),"-i")
 end)
 add_test(function(s)
  s:assert_eq(make_cn(4):notation(),"4i")
 end)
 add_test(function(s)
  s:assert_eq(make_cn(-4):notation(),"-4i")
 end)
 add_test(function(s)
  s:assert_eq(make_cn(0):notation(),"err")
 end)
 add_test(function(s)
  s:assert_true(make_cn(4):equals(make_cn(4)))
  s:assert_true(not make_cn(4):equals(make_cn(2)))
 end)
end

function _init()
 reset()
end

function _update()
 for t in all(suite) do t:update() end
 if btnp(fire1) then
  if #suite>=cnt then
    suite[cnt]:test()
    cnt+=1
  end
 end
 if btnp(fire2) then reset() end
end

function _draw()
 cls(1)
 for t in all(suite) do t:draw() end
end
-->8

function sqr(x) return x*x end

function make_fire(x,y,dst)
 local f={
  bullets={},
  update=function(s)
   for v in all(s.bullets) do
    v:update()
   end
  end,
  draw=function(s)
   for v in all(s.bullets) do
    v:draw()
   end
  end,
  show=function(s)
   local f=false
   for v in all(s.bullets) do
    if v.show then f=true end
   end
   return f
  end
 }
 for i=0,15 do
  f.bullets[i]=make_bullet(x,y,
                           20+dst,
                           rnd(1))
 end
 return f
end

function make_bullet(x,y,dst,r)
 return {
  show=true,
  sx=x,sy=y,x=x,y=y,dst=dst,
  dx=cos(r),dy=sin(r),
  mx=x+dst*cos(r),my=y+dst*sin(r),
  accel=1.5,tick=1,tick_base=7.5,
  update=function(s)
   if not s.show then return end
   s.tick+=1
   local speed=s.accel/(s.tick/s.tick_base)
   s.x+=s.dx*speed
   s.y+=s.dy*speed
   s.show=flr(sqrt(sqr(s.sx-s.x)+sqr(s.sy-s.y)))<s.dst
  end,
  draw=function(s)
   if not s.show then return end
   circfill(s.x,s.y,1,7)
  end
 }
end

__gfx__
00000000004444400044444000444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000004ffff0004ffff0004ffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700004f0f00004f0f00004f0f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000004ffff0004ffff0004ffff0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000008888000888880000888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700008888000088888008888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000cccc0000cccc0000cccc00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000c00c000c00c00000c000c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000088888000000000008888800000000000000000000000000000000000fff0000000000000000000000000000000000000000000000000000000000000000
0000888888888000000088888888800000000888880000000000008888800fff0000000000000000000000000000000000000000000000000000000000000000
0000333ff3f000000000333ff3f00000000088888888800000000888888888ff0000008888000000000000000000000000000000000000000000000000000000
0003f3fff3fff0000003f3fff3fff0000000333ff3f0000000000333ff3f0333000f08888880f000000000000000000000000000000000000000000000000000
0003f33fff3fff000003f33fff3fff000003f3fff3fff00000003f3fff3fff330fff3f3ff3f3fff0000000000000000000000000000000000000000000000000
00033ffff333300000033ffff33330000003f33fff3fff0000003f33fff3fff30ff33f3ff3f33ff0000000000000000000000000000000000000000000000000
00000fffffff000000000fffffff000000033ffff3333000000033ffff3333300ff333ffff333ff0000000000000000000000000000000000000000000000000
0000338333000000003333883300000000000fffffff0000000000fffffff3000003333ff3333000000000000000000000000000000000000000000000000000
0003338338333000ff3333888333fff000003333830f0000003333383338300000003f3333f30000000000000000000000000000000000000000000000000000
0033338888333300fff0338888833ff0000f333333fff000033333338333800300003ffffff30000000000000000000000000000000000000000000000000000
00ff38a88a83ff00ff00888a8880030000ff833333ff0000ff33333388888003000888ffff888000000000000000000000000000000000000000000000000000
00fff888888fff0000088888888833000033888888800000fff088388a88a8330033883333883300000000000000000000000000000000000000000000000000
00ff88888888ff00008888888888330000388888888000000f038888888888330033388338833300000000000000000000000000000000000000000000000000
0000888008880000033888000888330003388808880000000033388888888833003338a88a833300000000000000000000000000000000000000000000000000
00033300003330000333000000000000030000333000000003338888888000000033388888833300000000000000000000000000000000000000000000000000
00333300003333000033300000000000000000333300000003008888000000000003388888833000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
4141414141414141414141414141414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414100000000000000414141414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141000041414141414141000000414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000410041414100000000000041414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141000041414100004100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141000000004141414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4141414141414141414141414141414100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4040404040404040404040404040404000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
